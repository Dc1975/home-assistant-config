- id: '1683712408062'
  alias: HA Rolladen ab Sommerbetrieb
  description: ""
  trigger:  
#    - platform: template
#      # TODO check this automation every 5 minutes during the time intervall from
#      # idt_ha_covers_close_summer_after and idt_ha_covers_close_summer_before
#      value_template: >
#        {% set state_sensor = states('sensor.gw1100a_v2_2_3_outdoor_temperature')
#        %} {% set state_threshold =
#        states('input_number.in_ha_covers_temperature_treshhold') %}     {% if
#        is_number(state_sensor) and is_number(state_threshold) and (state_sensor |
#        float >= state_threshold | float) %}
#          true
#        {% else %}
#          false
#        {% endif %}      
#    - enabled: false
#      platform: sun
#      event: sunset
#      platform: template
#      value_template: > 
#        {% set now = now().timestamp() %}
#          {{ now | timestamp_custom('%H:%M')  >= (state_attr('input_datetime.idt_ha_covers_close_summer_before', 'timestamp') | as_datetime).strftime('%H:%M') or
#            now | timestamp_custom('%H:%M')  <= (state_attr('input_datetime.idt_ha_covers_close_summer_after', 'timestamp') | as_datetime).strftime('%H:%M') }}
    - platform: state
      entity_id:
        - sensor.gw1100a_v2_2_3_outdoor_temperature        
  condition:
    - condition: and
      conditions:
        - condition: time
          after: input_datetime.idt_ha_covers_close_summer_after
          before: input_datetime.idt_ha_covers_close_summer_before
        - condition: template
          value_template: >
            {% set state_sensor = states('sensor.gw1100a_v2_2_3_solar_lux') %} {%
            set state_threshold =
            states('input_number.in_ha_covers_lux_treshhold') %} {% if
            is_number(state_sensor) and is_number(state_threshold) and
            (state_sensor | float >= state_threshold | float) %}
              true
            {% else %}
              false
            {% endif %}                
        - condition: template
          value_template: >
            {% set state_sensor =
            states('sensor.gw1100a_v2_2_3_outdoor_temperature') %} {% set
            state_threshold =
            states('input_number.in_ha_covers_temperature_treshhold') %} {% if
            is_number(state_sensor) and is_number(state_threshold) and
            (state_sensor | float >= state_threshold | float) %}
              true
            {% else %}
              false
            {% endif %}    
        - condition: template
          value_template: >
            {{now().month | string in
            states('input_text.it_ha_covers_close_summer_months')}}            
  action:
# Wohnzimmertür
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{states('input_boolean.ib_wz_tur_covers_use_summer_mode') == 'on' and (state_attr('cover.wohnzimmertur_curtain', 'current_position') | int) > positionToSet }}
      then:    
      - service: script.turn_on
        data:
          variables:
          # TODO create an offset input_number
            #cover_position: "{{ (states('input_number.in_ha_covers_close_position_summer') | int)  - 25}}"
            cover_position: "{{ (states('input_number.in_ha_covers_close_position_summer') | int)  - 0}}"            
        target:
          entity_id: script.wz_rolladen_ab_tur
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_wz_tur_covers_closed_by_summer_mode
# Wohnzimmerfenster
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{states('input_boolean.ib_wz_fenster_covers_use_summer_mode') == 'on' and (state_attr('cover.wohnzimmerfensterrolladen', 'current_position') | int) > positionToSet }}
      then:    
      - service: script.turn_on
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        target:
          entity_id: script.wz_rolladen_ab_fenster
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_wz_fenster_covers_closed_by_summer_mode                              
# Dachgeschoss
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{states('input_boolean.ib_dg_covers_use_summer_mode') == 'on' and (state_attr('cover.dachgeschossfensterrolladen', 'current_position') | int) > positionToSet }}
      then:    
        - service: script.turn_on
          target:
            entity_id: script.dg_rolladen_ab
          data:
            variables:
              cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        - service: input_boolean.turn_on
          data: {}
          target:
            entity_id: input_boolean.ib_dg_covers_closed_by_summer_mode          
# Ankleidezimmer     
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{states('input_boolean.ib_sz_az_covers_use_summer_mode') == 'on' and (state_attr('cover.ankleidezimmerfensterrolladen', 'current_position') | int) > positionToSet }}
      then:    
      - service: script.turn_on
        target:
          entity_id: script.sz_az_rolladen_ab
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_sz_az_covers_closed_by_summer_mode  
# Schlafzimmer         
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{states('input_boolean.ib_sz_covers_use_summer_mode') == 'on' and (state_attr('cover.schlafzimmerfensterrolladen', 'current_position') | int) > positionToSet }}
      then:    
      - service: script.turn_on
        target:
          entity_id: script.sz_rolladen_ab
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_sz_covers_closed_by_summer_mode       
# Gästezimmer          
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{states('input_boolean.ib_gz_covers_use_summer_mode') == 'on' and (state_attr('cover.gastezimmerfensterrolladen', 'current_position') | int) > positionToSet }}
      then:    
      - service: script.turn_on
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        target:
          entity_id: script.gz_rolladen_ab                
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_gz_covers_closed_by_summer_mode                    
# Küche       
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{states('input_boolean.ib_ku_covers_use_summer_mode') == 'on' and (state_attr('cover.kuchenfensterrolladen', 'current_position') | int) > positionToSet }}          
      then:    
      - service: script.turn_on
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        target:
          entity_id: script.ku_rolladen_ab                
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_ku_covers_closed_by_summer_mode 
# Badezimmer
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{states('input_boolean.ib_bz_covers_use_summer_mode') == 'on' and (state_attr('cover.badezimmerfensterrolladen', 'current_position') | int) > positionToSet }}                    
      then:    
      - service: script.turn_on
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        target:
          entity_id: script.bz_rolladen_ab                
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_bz_covers_closed_by_summer_mode                          
  mode: single
