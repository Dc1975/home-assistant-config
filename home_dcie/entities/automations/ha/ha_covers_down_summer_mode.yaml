- id: '1683712408062'
  alias: HA Rolladen ab Sommerbetrieb
  description: ""
  trigger:  
    - platform: state
      entity_id:
        - sensor.gw1100a_v2_2_3_outdoor_temperature        
  condition:
    - condition: and
      conditions:
        - condition: time
          after: input_datetime.idt_ha_covers_close_summer_after
          before: input_datetime.idt_ha_covers_close_summer_before
        - condition: template
          value_template: >
            {% set state_sensor = states('sensor.gw1100a_v2_2_3_solar_lux') %} {%
            set state_threshold =
            states('input_number.in_ha_covers_lux_treshhold') %} {% if
            is_number(state_sensor) and is_number(state_threshold) and
            (state_sensor | float >= state_threshold | float) %}
              true
            {% else %}
              false
            {% endif %}                
        - condition: template
          value_template: >
            {% set state_sensor =
            states('sensor.gw1100a_v2_2_3_outdoor_temperature') %} {% set
            state_threshold =
            states('input_number.in_ha_covers_temperature_treshhold') %} {% if
            is_number(state_sensor) and is_number(state_threshold) and
            (state_sensor | float >= state_threshold | float) %}
              true
            {% else %}
              false
            {% endif %}    
        - condition: template
          value_template: >
            {{now().month | string in
            states('input_text.it_ha_covers_close_summer_months')}}            
  action:
# Wohnzimmertür
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{ states('input_boolean.ib_wz_door_covers_use_summer_mode') == 'on' and (state_attr('sensor.sr_wz_cover_door', 'get_position') | int) < positionToSet and
              states('input_boolean.ib_wz_door_covers_closed_by_summer_mode') == 'off' }}                          
      then:    
      - service: script.turn_on
        data:
          variables:
          # TODO create an offset input_number
            #cover_position: "{{ (states('input_number.in_ha_covers_close_position_summer') | int)  - 25}}"
            cover_position: "{{ (states('input_number.in_ha_covers_close_position_summer') | int)  - 0}}"            
        target:
          entity_id: script.wz_covers_down_door
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_wz_door_covers_closed_by_summer_mode
# Wohnzimmerfenster
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}            
            {{ states('input_boolean.ib_wz_window_covers_use_summer_mode') == 'on' and (state_attr('sensor.sr_wz_cover_window', 'get_position') | int) < positionToSet and
              states('input_boolean.ib_wz_window_covers_closed_by_summer_mode') == 'off' }}                          
      then:    
      - service: script.turn_on
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        target:
          entity_id: script.wz_covers_down_window
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_wz_window_covers_closed_by_summer_mode                              
# Dachgeschoss
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{ states('input_boolean.ib_dg_covers_use_summer_mode') == 'on' and (state_attr('sensor.sr_dg_cover', 'get_position') | int) < positionToSet and
              states('input_boolean.ib_dg_covers_closed_by_summer_mode') == 'off' }}                          
      then:    
        - service: script.turn_on
          target:
            entity_id: script.dg_covers_down
          data:
            variables:
              cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        - service: input_boolean.turn_on
          data: {}
          target:
            entity_id: input_boolean.ib_dg_covers_closed_by_summer_mode          
# Ankleidezimmer     
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}            
            {{ states('input_boolean.ib_sz_az_covers_use_summer_mode') == 'on' and (state_attr('sensor.sr_sz_az_cover', 'get_position') | int) < positionToSet and
              states('input_boolean.ib_sz_az_covers_closed_by_summer_mode') == 'off' }}
      then:    
      - service: script.turn_on
        target:
          entity_id: script.sz_az_covers_down
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_sz_az_covers_closed_by_summer_mode  
# Schlafzimmer         
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{ states('input_boolean.ib_sz_covers_use_summer_mode') == 'on' and (state_attr('sensor.sr_sz_cover', 'get_position') | int) < positionToSet and
              states('input_boolean.ib_sz_covers_closed_by_summer_mode') == 'off' }}
      then:    
      - service: script.turn_on
        target:
          entity_id: script.sz_covers_down
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_sz_covers_closed_by_summer_mode       
# Gästezimmer          
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{ states('input_boolean.ib_gz_covers_use_summer_mode') == 'on' and (state_attr('sensor.sr_gz_cover', 'get_position') | int) < positionToSet and
              states('input_boolean.ib_gz_covers_closed_by_summer_mode') == 'off' }}                                      
      then:    
      - service: script.turn_on
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        target:
          entity_id: script.gz_covers_down                
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_gz_covers_closed_by_summer_mode                    
# Küche       
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{ states('input_boolean.ib_ku_covers_use_summer_mode') == 'on' and (state_attr('sensor.sr_ku_cover', 'get_position') | int) < positionToSet and
              states('input_boolean.ib_ku_covers_closed_by_summer_mode') == 'off' }}                                      
      then:    
      - service: script.turn_on
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        target:
          entity_id: script.ku_covers_down                
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_ku_covers_closed_by_summer_mode 
# Badezimmer
    - if:
        - condition: template
          value_template: >
            {% set positionToSet = (states('input_number.in_ha_covers_close_position_summer') | int) %}
            {{ states('input_boolean.ib_bz_covers_use_summer_mode') == 'on' and (state_attr('sensor.sr_bz_cover', 'get_position') | int) < positionToSet and
              states('input_boolean.ib_bz_covers_closed_by_summer_mode') == 'off' }}                          
      then:    
      - service: script.turn_on
        data:
          variables:
            cover_position: "{{states('input_number.in_ha_covers_close_position_summer') | int}}"
        target:
          entity_id: script.bz_covers_down                
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id: input_boolean.ib_bz_covers_closed_by_summer_mode                          
  mode: single
