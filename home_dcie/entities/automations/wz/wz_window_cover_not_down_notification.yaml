- id: '1712138223486'
  alias: WZ Fensterrollade nicht geschlossen Warnung
  description: ''
  trigger:
  - platform: template
    value_template: >
      {{as_timestamp(today_at(states('input_datetime.idt_wz_window_cover_down_workday'))) | as_datetime | as_local + timedelta(minutes=states('input_number.in_ha_covers_check_after_minutes') | int)}}
  - platform: template
    value_template: >
      {{as_timestamp(today_at(states('input_datetime.idt_wz_window_cover_down_weekend'))) | as_datetime | as_local + timedelta(minutes=states('input_number.in_ha_covers_check_after_minutes') | int)}}      
  condition:
    - condition: template
      value_template: >
        {{ state_attr('sensor.sr_wz_cover_window', 'is_open') == true }}
  action: 
  - service: script.turn_on
    target:
      entity_id: script.ha_handy_notification
    data:
      variables:
        msg_title: "{{states('input_text.it_general_notification_title')}}Rolladen-Warnung"
        msg_message: "Der {{state_attr('cover.wohnzimmerfensterrolladen_tuya', 'friendly_name')}} wurde nicht geschlossen."
  - if:
      - condition: state
        entity_id: person.dcie
        state: home
    then:        
      - service: notify.alexa_media_uberall
        data:      
          title: "{{states('input_text.it_general_notification_title')}}Rolladen-Warnung"
          message: "Der {{state_attr('cover.wohnzimmerfensterrolladen_tuya', 'friendly_name')}} wurde nicht geschlossen."
          data:
            type: announce
            method: all          
# retry to open the cover again             
  - service: script.turn_on
    target:
      entity_id: script.wz_covers_down_window_execute
    data: {}  
# wait for script execution to check...              
  - if:
      - condition: template
        value_template: "{{states('input_boolean.ib_wait_for_script') == 'on'}}"
    then:    
      - wait_template: "{{is_state('script.wz_covers_down_window_execute', 'off') }}"                
        continue_on_timeout: true             
  mode: single
