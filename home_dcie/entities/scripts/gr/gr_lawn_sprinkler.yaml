gr_lawn_sprinkler:
  alias: GR Rasenbewässerung
  sequence:
    - condition: template
      value_template: "{{states('input_boolean.ib_gr_lawn_sprinkler_used_in_automations') == 'on' }}"   
    - if:
      - condition: template
        value_template: "{{ states('switch.brunnen') == 'unavailable' }}"
      then:
        - service: script.turn_on
          target:
            entity_id: script.ha_handy_notification
          data:
            variables:
              msg_title: "{{states('input_text.it_general_notification_title')}} Garten"
              msg_message: "Der Rasen kann nicht bewässert werden. Der Schalter {{ state_attr('switch.brunnen', 'friendly_name') }} ist nicht verfügbar."
        - service: notify.alexa_media_uberall
          data:
            title: "{{states('input_text.it_general_notification_title')}} Garten"
            message: "Der Rasen kann nicht bewässert werden. Der Schalter {{ state_attr('switch.brunnen', 'friendly_name') }} ist nicht verfügbar."
            data:
              type: announce
              method: all              
      else:  
        - service: switch.turn_on
          data: {}
          target:
            entity_id: switch.brunnen
# wait if switch is really turned on          
        - delay:
            hours: 0
            minutes: 0
            seconds: 5
            milliseconds: 0          
        - if:
          - condition: template
            value_template: "{{ states('switch.brunnen') == 'unavailable' or  states('switch.brunnen') == 'off' }}"
          then: 
            - service: script.turn_on
              target:
                entity_id: script.ha_handy_notification
              data:
                variables:
                  msg_title: "{{states('input_text.it_general_notification_title')}} Garten"
                  msg_message: "Der Rasen kann nicht bewässert werden. Der Schalter {{ state_attr('switch.brunnen', 'friendly_name') }} ist nicht verfügbar."
            - service: notify.alexa_media_uberall
              data:
                title: "{{states('input_text.it_general_notification_title')}} Garten"
                message: "Der Rasen kann nicht bewässert werden. Der Schalter {{ state_attr('switch.brunnen', 'friendly_name') }} ist nicht verfügbar."
                data:
                  type: announce
                  method: all             
          else:
            - service: script.turn_on
              target:
                entity_id: script.ha_handy_notification
              data:
                variables:
                  msg_title: "{{states('input_text.it_general_notification_title')}} Garten"
                  msg_message: "Der Rasen wird für {{states('input_number.in_gr_duration_lawn_sprinkler') | round(0) }} Minuten bewässert"
            - service: notify.alexa_media_uberall
              data:
                title: "{{states('input_text.it_general_notification_title')}} Garten"
                message: "Der Rasen wird für {{states('input_number.in_gr_duration_lawn_sprinkler') | round(0) }} Minuten bewässert"
                data:
                  type: announce
                  method: all
            - service: timer.start
              data_template:
                entity_id: timer.ti_gr_lawn_sprinkler
                duration: "00:{{states('input_number.in_gr_duration_lawn_sprinkler') | int}}:00"
            # lawn sprinkler timer 
            # https://community.home-assistant.io/t/stopwatch-with-start-stop-resume-lap-and-reset/443994/49
            - service: input_boolean.turn_on 
              data: {} 
              target: 
                entity_id: input_boolean.reset_stopwatch_lawn_sprinkler
            - service: input_boolean.turn_on 
              data: {} 
              target: 
                entity_id: input_boolean.start_stopwatch_lawn_sprinkler          
  mode: single